#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

pnpm -s lint-staged || true
# Robust pnpm resolution for local/CI/agent shells
export PNPM_HOME="${PNPM_HOME:-$HOME/.local/share/pnpm}"
export PATH="$PNPM_HOME:$PATH"
if ! command -v pnpm >/dev/null 2>&1; then
  if command -v corepack >/dev/null 2>&1; then
    corepack enable >/dev/null 2>&1 || true
    corepack prepare pnpm@10 --activate >/dev/null 2>&1 || true
  fi
  # Fallback install if still missing
  if ! command -v pnpm >/dev/null 2>&1; then
    echo "==> Installing pnpm (user-scoped)…"
    curl -fsSL https://get.pnpm.io/install.sh | sh -
    export PNPM_HOME="${PNPM_HOME:-$HOME/.local/share/pnpm}"
    export PATH="$PNPM_HOME:$PATH"
  fi
fi

# Run secret scan (non-fatal if gitleaks missing) + lint-staged
pnpm run precommit:secrets || echo "⚠️  precommit:secrets skipped/failed"
# Prefer pnpm dlx; fallback to npx if pnpm still unavailable
if command -v pnpm >/dev/null 2>&1; then
  pnpm dlx lint-staged
else
  npx --yes lint-staged
fi

# Enforce dependency version consistency (fails commit on drift)
if command -v pnpm >/dev/null 2>&1; then
  if ! pnpm run versions:check; then
    echo "❌ Version drift detected. Run 'pnpm run versions:sync' to update references." >&2
    exit 1
  fi
fi
